<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fuhrpark Verwaltung – Elektro Jungbauer</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f3f4f6; }
    header { background:#111827; color:#f9fafb; padding:1rem 1.5rem; display:flex; justify-content:space-between; align-items:center; gap:1rem; flex-wrap:wrap; }
    header h1 { margin:0; font-size:1.15rem; }
    header small { opacity:.85; }
    main { padding:1rem; display:grid; grid-template-columns: 1.1fr 1.4fr; gap:1rem; }
    @media (max-width: 980px){ main { grid-template-columns:1fr; } }
    .card { background:#fff; border-radius:.6rem; padding:1rem; box-shadow: 0 1px 4px rgba(0,0,0,.08); }
    h2 { margin:.1rem 0 .7rem; font-size:1rem; }
    h3 { margin:1rem 0 .4rem; font-size:.95rem; }
    label { display:block; font-size:.8rem; margin-top:.5rem; margin-bottom:.1rem; }
    input[type="text"], input[type="date"], input[type="number"], select, textarea {
      width:100%; box-sizing:border-box; padding:.35rem .45rem;
      border:1px solid #d1d5db; border-radius:.35rem; font-size:.85rem;
      background:#fff;
    }
    textarea { min-height:70px; }
    button { border:none; border-radius:.35rem; padding:.4rem .8rem; cursor:pointer; font-size:.85rem; }
    .btn-primary { background:#2563eb; color:#fff; }
    .btn-secondary { background:#e5e7eb; color:#111827; }
    .btn-danger { background:#dc2626; color:#fff; }
    .btn-small { font-size:.75rem; padding:.25rem .55rem; }
    table { width:100%; border-collapse:collapse; font-size:.8rem; }
    th, td { padding:.35rem .4rem; border-bottom:1px solid #e5e7eb; text-align:left; vertical-align:top; }
    th { background:#f9fafb; font-weight:600; }
    .flex { display:flex; gap:.6rem; flex-wrap:wrap; align-items:center; }
    .flex-between { display:flex; justify-content:space-between; align-items:center; gap:.5rem; flex-wrap:wrap; }
    .mt-1{ margin-top:.25rem; } .mt-2{ margin-top:.5rem; } .mt-3{ margin-top:.8rem; }
    .small { font-size:.78rem; color:#6b7280; }
    .badge { background:#e5e7eb; border-radius:999px; padding:.1rem .5rem; font-size:.7rem; display:inline-block; }
    .status-pill{ display:inline-block; padding:.12rem .5rem; border-radius:999px; font-size:.72rem; color:#fff; }
    .green{ background:#16a34a; } .orange{ background:#ea580c; } .red{ background:#dc2626; } .gray{ background:#6b7280; }
    hr { border:0; border-top:1px solid #e5e7eb; margin: .9rem 0; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .note-box { background:#f9fafb; border:1px solid #e5e7eb; border-radius:.5rem; padding:.6rem; }
  </style>
</head>
<body>
<header>
  <div>
    <h1>Fuhrpark Verwaltung</h1>
    <small>Elektro Jungbauer – lokal gespeichert</small>
  </div>
  <div class="small mono" id="storageInfo"></div>
</header>

<main>

  <!-- LINKS -->
  <section class="card">
    <div class="flex-between">
      <h2>Fahrzeuge</h2>
      <button class="btn-secondary btn-small" onclick="resetVehicleForm()">Neu</button>
    </div>

    <div class="mt-2">
      <label>Suche (Kennzeichen / Monteur / Marke)</label>
      <input type="text" id="search" placeholder="z.B. WN-..., Ali, VW..." oninput="renderVehicles()">
    </div>

    <table class="mt-2">
      <thead>
        <tr>
          <th>Kennzeichen</th>
          <th>Monteur</th>
          <th>Pickerl</th>
          <th>Leasing</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="vehicles-tbody"></tbody>
    </table>

    <hr>

    <h3>Gesamt – Termine & Planung</h3>
    <div class="flex">
      <div style="flex:1; min-width:200px;">
        <label>Jahr</label>
        <select id="agenda-year" onchange="renderAgenda()"></select>
      </div>
      <div style="flex:1; min-width:200px;">
        <label>Zeitraum</label>
        <select id="agenda-range" onchange="renderAgenda()">
          <option value="30">Nächste 30 Tage</option>
          <option value="60">Nächste 60 Tage</option>
          <option value="90" selected>Nächste 90 Tage</option>
          <option value="365">Nächste 365 Tage</option>
          <option value="all">Alle</option>
        </select>
      </div>
      <div style="flex:1; min-width:220px;">
        <label>Anzeige</label>
        <select id="agenda-mode" onchange="renderAgenda()">
          <option value="manual" selected>Nur Termine (manuell)</option>
          <option value="due">Nur Fälligkeiten (Pickerl/Leasing)</option>
          <option value="all">Beides</option>
        </select>
      </div>
    </div>

    <div class="note-box mt-2">
      <div class="small"><b>Termine (alle Autos)</b> – sortiert nach Datum.</div>
      <table class="mt-2">
        <thead>
          <tr><th>Datum</th><th>Auto</th><th>Art</th><th>Notiz</th></tr>
        </thead>
        <tbody id="agenda-tbody"></tbody>
      </table>
    </div>

    <hr>

    <h3>Import / Backup</h3>
    <div class="flex mt-2">
      <div style="flex:1; min-width:240px;">
        <label>CSV importieren (aus Excel)</label>
        <input type="file" id="csvInput" accept=".csv" onchange="importCSV(event)">
        <div class="small">Tipp: Excel als <b>CSV (UTF-8)</b> speichern.</div>
      </div>

      <div style="flex:1; min-width:240px;">
        <label>Backup (CSV-Datei)</label>
        <div class="flex">
          <button class="btn-secondary btn-small" onclick="exportBackup()">CSV-Backup erstellen</button>
          <input type="file" id="backupInput" accept=".csv" onchange="importBackup(event)">
        </div>
        <div class="small">Import fragt: <b>Ersetzen</b> oder <b>Anhängen</b>.</div>
      </div>
    </div>

    <hr>

    <h3>Fahrzeug anlegen / bearbeiten</h3>
    <form id="vehicle-form" onsubmit="saveVehicle(event)">
      <input type="hidden" id="vehicle-id">

      <label>Kennzeichen</label>
      <input type="text" id="kennzeichen" required>

      <label>Monteur</label>
      <input type="text" id="monteur">

      <label>Auto Marke / Modell</label>
      <input type="text" id="marke">

      <div class="flex">
        <div style="flex:1; min-width:180px;">
          <label>Gewicht (t)</label>
          <input type="number" step="0.01" id="gewicht">
        </div>
        <div style="flex:1; min-width:180px;">
          <label>Pickerl (Monat/Jahr)</label>
          <select id="pickerl-bis"></select>
        </div>
      </div>

      <div class="flex mt-1">
        <div style="flex:1; min-width:180px;">
          <label>Leasing läuft bis (Monat/Jahr)</label>
          <select id="leasing-bis"></select>
        </div>
        <div style="flex:1; min-width:180px;">
          <label>Leasing Info</label>
          <input type="text" id="leasing-info">
        </div>
      </div>

      <h3 class="mt-3">Reifenstatus</h3>
      <div class="flex">
        <div style="flex:1; min-width:180px;">
          <label>Sommerreifen</label>
          <select id="reifen-sommer-status">
            <option value="">–</option>
            <option value="ok">OK</option>
            <option value="bald">Bald</option>
            <option value="tausch">Fällig</option>
          </select>
        </div>
        <div style="flex:1; min-width:180px;">
          <label>Winterreifen</label>
          <select id="reifen-winter-status">
            <option value="">–</option>
            <option value="ok">OK</option>
            <option value="bald">Bald</option>
            <option value="tausch">Fällig</option>
          </select>
        </div>
        <div style="flex:1; min-width:180px;">
          <label>Allwetterreifen</label>
          <select id="reifen-allwetter-status">
            <option value="">–</option>
            <option value="ok">OK</option>
            <option value="bald">Bald</option>
            <option value="tausch">Fällig</option>
          </select>
        </div>
      </div>

      <div class="flex mt-1">
        <div style="flex:1; min-width:220px;">
          <label>Reifen gekauft bei</label>
          <input type="text" id="reifen-haendler" placeholder="z.B. BestDrive">
        </div>
        <div style="flex:1; min-width:220px;">
          <label>Reifen Kaufdatum</label>
          <input type="date" id="reifen-kaufdatum">
        </div>
      </div>

      <h3 class="mt-3">Service</h3>
      <div class="flex">
        <div style="flex:1; min-width:220px;">
          <label>Service gemacht am</label>
          <input type="date" id="service-datum">
        </div>
      </div>

      <label class="mt-2">Besondere Vermerke</label>
      <textarea id="notizen"></textarea>

      <div class="flex mt-2">
        <button type="submit" class="btn-primary">Speichern</button>
        <button type="button" class="btn-danger" onclick="deleteVehicle()" id="delete-vehicle-btn" style="display:none;">Fahrzeug löschen</button>
      </div>
    </form>
  </section>

  <!-- RECHTS -->
  <section class="card">
    <div class="flex-between">
      <h2 id="detail-title">Kein Fahrzeug ausgewählt</h2>
      <span id="detail-subtitle" class="small"></span>
    </div>

    <div id="detail-content" style="display:none;">
      <h3>Status</h3>
      <div class="flex">
        <div style="flex:1; min-width:220px;">
          <div class="small">Pickerl</div>
          <div id="pickerl-status-display"></div>
        </div>
        <div style="flex:1; min-width:220px;">
          <div class="small">Leasing</div>
          <div id="leasing-status-display"></div>
        </div>
      </div>

      <h3 class="mt-3">Kostenübersicht</h3>
      <div class="flex">
        <div style="flex:1; min-width:220px;">
          <label>Jahr auswählen</label>
          <select id="cost-year" onchange="renderCosts()"></select>
        </div>
      </div>
      <div class="note-box mt-2" id="cost-summary"></div>

      <h3 class="mt-3">Reifen</h3>
      <div class="small" id="reifen-display"></div>

      <h3 class="mt-3">Service</h3>
      <div class="small" id="service-display"></div>

      <h3 class="mt-3">Termine (dieses Auto)</h3>
      <form id="appt-form" onsubmit="addAppointment(event)">
        <div class="flex">
          <div style="flex:1; min-width:180px;">
            <label>Datum</label>
            <input type="date" id="appt-date" required>
          </div>
          <div style="flex:1; min-width:180px;">
            <label>Art</label>
            <select id="appt-type">
              <option>Werkstatt</option>
              <option>Pickerl</option>
              <option>Service</option>
              <option>Reifen</option>
              <option>Sonstiges</option>
            </select>
          </div>
        </div>
        <label class="mt-1">Notiz</label>
        <input type="text" id="appt-note" placeholder="z.B. 23.5 Pickerl bei XY, 08:00 Uhr">
        <button class="btn-primary btn-small mt-2" type="submit">Termin speichern</button>
      </form>

      <table class="mt-2">
        <thead><tr><th>Datum</th><th>Art</th><th>Notiz</th><th></th></tr></thead>
        <tbody id="appt-tbody"></tbody>
      </table>

      <h3 class="mt-3">Rechnungen</h3>
      <form id="invoice-form" onsubmit="addInvoice(event)">
        <div class="flex">
          <div style="flex:1; min-width:180px;">
            <label>Datum</label>
            <input type="date" id="inv-date" required>
          </div>
          <div style="flex:1; min-width:180px;">
            <label>Betrag (€)</label>
            <input type="number" step="0.01" id="inv-amount" required>
          </div>
        </div>

        <label class="mt-1">Werkstatt / Händler</label>
        <input type="text" id="inv-vendor">

        <label class="mt-1">Typ</label>
       <select id="inv-type">
  <option>Service</option>
  <option>Pickerl</option>
  <option>Reifen</option>
  <option>Sonstiges</option>
</select>


        <label class="mt-1">Datei (PDF / JPG / PNG)</label>
        <input type="file" id="inv-file" accept=".pdf,.jpg,.jpeg,.png">

        <div class="flex mt-2">
          <button class="btn-primary btn-small" type="submit">Rechnung speichern</button>
          <span class="small">Öffnen über Button „Öffnen“ (kein Chrome-Block).</span>
        </div>
      </form>

      <table class="mt-2">
        <thead>
          <tr>
            <th>Datum</th><th>Typ</th><th>€</th><th>Werkstatt</th><th>Datei</th><th></th>
          </tr>
        </thead>
        <tbody id="invoice-tbody"></tbody>
      </table>

      <h3 class="mt-3">Vermerke</h3>
      <div class="small" id="notizen-display" style="white-space: pre-line;"></div>
    </div>

    <div id="no-detail" class="small mt-2">
      Bitte links ein Fahrzeug öffnen.
    </div>
  </section>

</main>

<script>
/** =========================
 *  STORAGE + MIGRATION (KEIN DATENVERLUST)
 *  ========================= */
const STORAGE_KEY_STABLE = "fuhrpark_data_stable_v1";
const OLD_KEYS = [
  "fuhrpark_data_v1",
  "fuhrpark_data_v2",
  "fuhrpark_data_v2_backup",
  "fuhrpark_data_stable"
];

let data = { vehicles: [] };
let selectedVehicleId = null;

function safeParseJSON(raw){ try { return JSON.parse(raw); } catch { return null; } }
function normalizeMonth(value){
  if(!value) return "";
  if(typeof value !== "string") return "";
  if(/^\d{4}-\d{2}$/.test(value)) return value;
  if(/^\d{4}-\d{2}-\d{2}$/.test(value)) return value.slice(0,7);
  return value;
}

function migrateVehicle(v){
  const id = v.id || ("veh_" + Date.now() + "_" + Math.floor(Math.random()*10000));
  const out = {
    id,
    kennzeichen: v.kennzeichen ?? v.kz ?? "",
    monteur: v.monteur ?? "",
    marke: v.marke ?? "",
    gewicht: (v.gewicht ?? null),
    pickerlBis: normalizeMonth(v.pickerlBis ?? v.pickerl ?? ""),
    leasingBis: normalizeMonth(v.leasingBis ?? v.leasing ?? ""),
    leasingInfo: v.leasingInfo ?? "",
    reifenSommerStatus: v.reifenSommerStatus ?? v.reifen?.sommer ?? "",
    reifenWinterStatus: v.reifenWinterStatus ?? v.reifen?.winter ?? "",
    reifenAllwetterStatus: v.reifenAllwetterStatus ?? v.reifen?.all ?? "",
    reifenHaendler: v.reifenHaendler ?? "",
    reifenKaufdatum: v.reifenKaufdatum ?? "",
    serviceDatum: v.serviceDatum ?? v.service_datum ?? "",
    notizen: v.notizen ?? v.notiz ?? "",
    appointments: Array.isArray(v.appointments) ? v.appointments : [],
    invoices: Array.isArray(v.invoices) ? v.invoices : []
  };

  out.appointments = out.appointments.map(a => ({
    id: a.id || ("appt_" + Date.now() + "_" + Math.floor(Math.random()*10000)),
    date: a.date || a.datum || "",
    type: a.type || a.art || "Werkstatt",
    note: a.note || a.notiz || ""
  }));

  out.invoices = out.invoices.map(inv => ({
    id: inv.id || ("inv_" + Date.now() + "_" + Math.floor(Math.random()*10000)),
    date: inv.date || "",
    amount: inv.amount != null ? Number(inv.amount) : 0,
    vendor: inv.vendor || "",
    type: inv.type || "Sonstiges",
    file: inv.file || null // {name,type,data} oder evtl. alt: {data}
  }));

  return out;
}

function mergeVehicleLists(listA, listB){
  const map = new Map();
  const add = (v) => {
    const key = (v.kennzeichen || "").trim().toUpperCase() || v.id;
    if(!key) return;
    if(!map.has(key)) map.set(key, v);
    else {
      const old = map.get(key);
      const merged = {...old};
      for(const k in v){
        const val = v[k];
        if(val != null && val !== "" && !(Array.isArray(val) && val.length === 0)){
          merged[k] = val;
        }
      }
      merged.invoices = (old.invoices||[]).concat(v.invoices||[]);
      merged.appointments = (old.appointments||[]).concat(v.appointments||[]);
      map.set(key, merged);
    }
  };
  (listA||[]).forEach(add);
  (listB||[]).forEach(add);
  return Array.from(map.values());
}

function loadData(){
  const stableRaw = localStorage.getItem(STORAGE_KEY_STABLE);
  if(stableRaw){
    const stable = safeParseJSON(stableRaw);
    if(stable && Array.isArray(stable.vehicles)){
      data.vehicles = stable.vehicles.map(migrateVehicle);
      saveData();
      return;
    }
  }

  let collected = [];
  for(const k of OLD_KEYS){
    const raw = localStorage.getItem(k);
    const j = raw ? safeParseJSON(raw) : null;
    if(j && Array.isArray(j.vehicles) && j.vehicles.length){
      collected.push(j.vehicles.map(migrateVehicle));
    }
  }

  if(collected.length){
    let merged = collected[0];
    for(let i=1;i<collected.length;i++){
      merged = mergeVehicleLists(merged, collected[i]);
    }
    data.vehicles = merged;
    saveData();
  } else {
    data = { vehicles: [] };
    saveData();
  }
}

function saveData(){
  localStorage.setItem(STORAGE_KEY_STABLE, JSON.stringify(data));
  document.getElementById("storageInfo").textContent = "Storage: " + STORAGE_KEY_STABLE;
}

/** =========================
 *  HELPERS
 *  ========================= */
function formatMonthYM(ym){
  if(!ym) return "";
  if(/^\d{4}-\d{2}$/.test(ym)){
    const [y,m] = ym.split("-");
    return m + "." + y;
  }
  return ym;
}

function getMonthEndDate(ym){
  if(!ym) return null;
  if(!/^\d{4}-\d{2}$/.test(ym)) return null;
  const [y,m] = ym.split("-").map(Number);
  return new Date(y, m, 0);
}

function getStatusForMonth(ym, soonDays){
  if(!ym) return { text:"kein Datum", cls:"gray" };
  const end = getMonthEndDate(ym);
  if(!end) return { text:"ungültig ("+ym+")", cls:"gray" };
  const now = new Date();
  const diffDays = Math.ceil((end - now) / 86400000);
  const formatted = formatMonthYM(ym);
  if(diffDays < 0) return { text:"abgelaufen ("+formatted+")", cls:"red" };
  if(diffDays <= soonDays) return { text:"bald fällig ("+formatted+")", cls:"orange" };
  return { text:"OK bis "+formatted, cls:"green" };
}

function statusPillForReifen(val){
  if(val === "ok") return `<span class="status-pill green">OK</span>`;
  if(val === "bald") return `<span class="status-pill orange">Bald</span>`;
  if(val === "tausch") return `<span class="status-pill red">Fällig</span>`;
  return `<span class="status-pill gray">–</span>`;
}

function money(n){
  const x = Number(n || 0);
  return x.toFixed(2) + " €";
}

/** =========================
 *  MONTH DROPDOWNS
 *  ========================= */
function fillMonthDropdown(selectId, monthsAhead = 72){
  const sel = document.getElementById(selectId);
  if(!sel) return;
  const now = new Date();
  sel.innerHTML = `<option value="">–</option>`;
  for(let i=0;i<=monthsAhead;i++){
    const d = new Date(now.getFullYear(), now.getMonth()+i, 1);
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const val = `${y}-${m}`;
    const label = `${m}.${y}`;
    const opt = document.createElement("option");
    opt.value = val;
    opt.textContent = label;
    sel.appendChild(opt);
  }
}

/** =========================
 *  YEAR DROPDOWNS
 *  ========================= */
function getAvailableYears(){
  const years = new Set();
  const nowY = new Date().getFullYear();
  years.add(nowY);
  data.vehicles.forEach(v=>{
    (v.invoices||[]).forEach(i=>{
      if(i.date) years.add(new Date(i.date).getFullYear());
    });
    (v.appointments||[]).forEach(a=>{
      if(a.date) years.add(new Date(a.date).getFullYear());
    });
    if(v.pickerlBis){
      const d = getMonthEndDate(v.pickerlBis);
      if(d) years.add(d.getFullYear());
    }
    if(v.leasingBis){
      const d = getMonthEndDate(v.leasingBis);
      if(d) years.add(d.getFullYear());
    }
  });
  return Array.from(years).sort();
}

function ensureYearDropdowns(){
  const years = getAvailableYears();
  const setOptions = (selId) => {
    const sel = document.getElementById(selId);
    if(!sel) return;
    const current = sel.value;
    sel.innerHTML = "";
    years.forEach(y=>{
      const opt=document.createElement("option");
      opt.value=String(y);
      opt.textContent=String(y);
      sel.appendChild(opt);
    });
    const nowY = String(new Date().getFullYear());
    sel.value = years.includes(Number(current)) ? current : (years.includes(Number(nowY)) ? nowY : String(years[0]));
  };
  setOptions("cost-year");
  setOptions("agenda-year");
}

/** =========================
 *  VEHICLES
 *  ========================= */
function renderVehicles(){
  const q = (document.getElementById("search").value || "").trim().toLowerCase();
  const tbody = document.getElementById("vehicles-tbody");
  tbody.innerHTML = "";

  const list = (data.vehicles || []).slice().sort((a,b) => (a.kennzeichen||"").localeCompare(b.kennzeichen||""));

  list.forEach(v => {
    const hay = ((v.kennzeichen||"")+" "+(v.monteur||"")+" "+(v.marke||"")).toLowerCase();
    if(q && !hay.includes(q)) return;

    const p = getStatusForMonth(v.pickerlBis, 31);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${v.kennzeichen||""}</td>
      <td>${v.monteur||""}</td>
      <td><span class="badge">${p.text}</span></td>
      <td><span class="badge">${v.leasingBis ? ("bis " + formatMonthYM(v.leasingBis)) : "–"}</span></td>
      <td><button class="btn-secondary btn-small" onclick="selectVehicle('${v.id}')">Öffnen</button></td>
    `;
    tbody.appendChild(tr);
  });

  ensureYearDropdowns();
  renderAgenda();
}

function resetVehicleForm(){
  document.getElementById("vehicle-id").value = "";
  document.getElementById("kennzeichen").value = "";
  document.getElementById("monteur").value = "";
  document.getElementById("marke").value = "";
  document.getElementById("gewicht").value = "";
  document.getElementById("pickerl-bis").value = "";
  document.getElementById("leasing-bis").value = "";
  document.getElementById("leasing-info").value = "";
  document.getElementById("reifen-sommer-status").value = "";
  document.getElementById("reifen-winter-status").value = "";
  document.getElementById("reifen-allwetter-status").value = "";
  document.getElementById("reifen-haendler").value = "";
  document.getElementById("reifen-kaufdatum").value = "";
  document.getElementById("service-datum").value = "";
  document.getElementById("notizen").value = "";
  document.getElementById("delete-vehicle-btn").style.display = "none";
}

function selectVehicle(id){
  selectedVehicleId = id;
  const v = data.vehicles.find(x => x.id === id);
  if(!v) return;

  document.getElementById("vehicle-id").value = v.id;
  document.getElementById("kennzeichen").value = v.kennzeichen || "";
  document.getElementById("monteur").value = v.monteur || "";
  document.getElementById("marke").value = v.marke || "";
  document.getElementById("gewicht").value = (v.gewicht != null ? v.gewicht : "");
  document.getElementById("pickerl-bis").value = v.pickerlBis || "";
  document.getElementById("leasing-bis").value = v.leasingBis || "";
  document.getElementById("leasing-info").value = v.leasingInfo || "";
  document.getElementById("reifen-sommer-status").value = v.reifenSommerStatus || "";
  document.getElementById("reifen-winter-status").value = v.reifenWinterStatus || "";
  document.getElementById("reifen-allwetter-status").value = v.reifenAllwetterStatus || "";
  document.getElementById("reifen-haendler").value = v.reifenHaendler || "";
  document.getElementById("reifen-kaufdatum").value = v.reifenKaufdatum || "";
  document.getElementById("service-datum").value = v.serviceDatum || "";
  document.getElementById("notizen").value = v.notizen || "";

  document.getElementById("delete-vehicle-btn").style.display = "inline-block";

  document.getElementById("detail-title").textContent = v.kennzeichen || "(ohne Kennzeichen)";
  document.getElementById("detail-subtitle").textContent = (v.monteur || "") + (v.marke ? " – " + v.marke : "");

  document.getElementById("detail-content").style.display = "block";
  document.getElementById("no-detail").style.display = "none";

  const p = getStatusForMonth(v.pickerlBis, 31);
  const l = getStatusForMonth(v.leasingBis, 183);

  document.getElementById("pickerl-status-display").innerHTML = `<span class="status-pill ${p.cls}">${p.text}</span>`;
  document.getElementById("leasing-status-display").innerHTML = `<span class="status-pill ${l.cls}">${l.text}${v.leasingInfo ? " | " + v.leasingInfo : ""}</span>`;

  document.getElementById("reifen-display").innerHTML = `
    Sommer: ${statusPillForReifen(v.reifenSommerStatus)} &nbsp;|&nbsp;
    Winter: ${statusPillForReifen(v.reifenWinterStatus)} &nbsp;|&nbsp;
    Allwetter: ${statusPillForReifen(v.reifenAllwetterStatus)}
    <div class="mt-1">
      Händler: <b>${(v.reifenHaendler||"-")}</b>
      ${v.reifenKaufdatum ? " | Kaufdatum: <b>"+v.reifenKaufdatum+"</b>" : ""}
    </div>
  `;

  document.getElementById("service-display").innerHTML =
    v.serviceDatum ? `Service gemacht am: <b>${v.serviceDatum}</b>` : `<span class="badge">kein Service-Datum</span>`;

  document.getElementById("notizen-display").textContent = v.notizen || "–";

  ensureYearDropdowns();
  renderCosts();
  renderAppointments();
  renderInvoices();
  renderAgenda();
}

function saveVehicle(event){
  event.preventDefault();
  const id = document.getElementById("vehicle-id").value || ("veh_" + Date.now() + "_" + Math.floor(Math.random()*10000));
  const existing = data.vehicles.find(x => x.id === id);

  const payload = {
    id,
    kennzeichen: document.getElementById("kennzeichen").value.trim(),
    monteur: document.getElementById("monteur").value.trim(),
    marke: document.getElementById("marke").value.trim(),
    gewicht: document.getElementById("gewicht").value ? Number(document.getElementById("gewicht").value) : null,
    pickerlBis: normalizeMonth(document.getElementById("pickerl-bis").value || ""),
    leasingBis: normalizeMonth(document.getElementById("leasing-bis").value || ""),
    leasingInfo: document.getElementById("leasing-info").value.trim(),
    reifenSommerStatus: document.getElementById("reifen-sommer-status").value,
    reifenWinterStatus: document.getElementById("reifen-winter-status").value,
    reifenAllwetterStatus: document.getElementById("reifen-allwetter-status").value,
    reifenHaendler: document.getElementById("reifen-haendler").value.trim(),
    reifenKaufdatum: document.getElementById("reifen-kaufdatum").value || "",
    serviceDatum: document.getElementById("service-datum").value || "",
    notizen: document.getElementById("notizen").value.trim()
  };

  if(existing){
    payload.invoices = existing.invoices || [];
    payload.appointments = existing.appointments || [];
    Object.assign(existing, payload);
  } else {
    payload.invoices = [];
    payload.appointments = [];
    data.vehicles.push(payload);
  }

  saveData();
  renderVehicles();
  document.getElementById("vehicle-id").value = id;
  document.getElementById("delete-vehicle-btn").style.display = "inline-block";
  selectVehicle(id);
}

function deleteVehicle(){
  const id = document.getElementById("vehicle-id").value;
  if(!id) return;
  if(!confirm("Fahrzeug wirklich löschen?")) return;

  data.vehicles = data.vehicles.filter(v => v.id !== id);
  saveData();
  renderVehicles();
  resetVehicleForm();
  selectedVehicleId = null;

  document.getElementById("detail-content").style.display = "none";
  document.getElementById("no-detail").style.display = "block";
  document.getElementById("detail-title").textContent = "Kein Fahrzeug ausgewählt";
  document.getElementById("detail-subtitle").textContent = "";
  renderAgenda();
}

/** =========================
 *  COSTS (pro Auto + Gesamt)
 *  ========================= */
function calculateCosts(year, vehicleOrNull){
  let service=0, reifen=0, sonst=0;
  const vehicles = vehicleOrNull ? [vehicleOrNull] : data.vehicles;

  vehicles.forEach(v=>{
    (v.invoices||[]).forEach(i=>{
      if(!i.date) return;
      if(new Date(i.date).getFullYear() !== Number(year)) return;
      const amount = Number(i.amount||0);
      if(i.type==="Service") service += amount;
      else if(i.type==="Reifen") reifen += amount;
      else sonst += amount;
    });
  });
  return {service, reifen, sonst, gesamt: service+reifen+sonst};
}

function renderCosts(){
  const yearSel = document.getElementById("cost-year");
  const box = document.getElementById("cost-summary");
  if(!yearSel || !box) return;

  const year = yearSel.value || String(new Date().getFullYear());
  const v = selectedVehicleId ? data.vehicles.find(x=>x.id===selectedVehicleId) : null;

  const perVehicle = calculateCosts(year, v);
  const overall = calculateCosts(year, null);

  box.innerHTML = `
    <div class="small"><b>Dieses Auto (${v ? (v.kennzeichen||"") : "-"})</b></div>
    <div>Service: <b>${money(perVehicle.service)}</b></div>
    <div>Reifen: <b>${money(perVehicle.reifen)}</b></div>
    <div>Sonstiges: <b>${money(perVehicle.sonst)}</b></div>
    <hr>
    <div><b>GESAMT Auto: ${money(perVehicle.gesamt)}</b></div>
    <hr>
    <div class="small"><b>Gesamt Fuhrpark (${year})</b></div>
    <div>Service: <b>${money(overall.service)}</b></div>
    <div>Reifen: <b>${money(overall.reifen)}</b></div>
    <div>Sonstiges: <b>${money(overall.sonst)}</b></div>
    <div><b>GESAMT Fuhrpark: ${money(overall.gesamt)}</b></div>
  `;
}

/** =========================
 *  APPOINTMENTS (pro Auto)
 *  ========================= */
function addAppointment(event){
  event.preventDefault();
  if(!selectedVehicleId) return;
  const v = data.vehicles.find(x=>x.id===selectedVehicleId);
  if(!v) return;

  v.appointments = v.appointments || [];
  v.appointments.push({
    id: "appt_" + Date.now() + "_" + Math.floor(Math.random()*10000),
    date: document.getElementById("appt-date").value,
    type: document.getElementById("appt-type").value,
    note: document.getElementById("appt-note").value.trim()
  });

  saveData();
  document.getElementById("appt-form").reset();
  renderAppointments();
  renderAgenda();
  ensureYearDropdowns();
}

function deleteAppointment(id){
  const v = data.vehicles.find(x=>x.id===selectedVehicleId);
  if(!v) return;
  v.appointments = (v.appointments||[]).filter(a=>a.id!==id);
  saveData();
  renderAppointments();
  renderAgenda();
  ensureYearDropdowns();
}

function renderAppointments(){
  const tbody = document.getElementById("appt-tbody");
  tbody.innerHTML = "";
  if(!selectedVehicleId) return;
  const v = data.vehicles.find(x=>x.id===selectedVehicleId);
  if(!v) return;

  const list = (v.appointments||[]).slice().sort((a,b)=> (a.date||"").localeCompare(b.date||""));
  list.forEach(a=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td>${a.date||""}</td>
      <td>${a.type||""}</td>
      <td>${a.note||""}</td>
      <td><button class="btn-danger btn-small" onclick="deleteAppointment('${a.id}')">X</button></td>
    `;
    tbody.appendChild(tr);
  });
}

/** =========================
 *  AGENDA (alle Autos) + FILTER B
 *  ========================= */
function buildAgendaItems(mode){
  const items = [];
  data.vehicles.forEach(v=>{
    const kz = v.kennzeichen || "";

    if(mode === "manual" || mode === "all"){
      (v.appointments||[]).forEach(a=>{
        if(a.date){
          items.push({date: a.date, car: kz, type: a.type, note: a.note || ""});
        }
      });
    }

    if(mode === "due" || mode === "all"){
      if(v.pickerlBis){
        const d = getMonthEndDate(v.pickerlBis);
        if(d){
          const iso = d.toISOString().slice(0,10);
          items.push({date: iso, car: kz, type: "Pickerl (fällig)", note: "Fälligkeit ("+formatMonthYM(v.pickerlBis)+")"});
        }
      }
      if(v.leasingBis){
        const d = getMonthEndDate(v.leasingBis);
        if(d){
          const iso = d.toISOString().slice(0,10);
          items.push({date: iso, car: kz, type: "Leasing (Ende)", note: "Ende ("+formatMonthYM(v.leasingBis)+")"});
        }
      }
    }
  });

  return items.filter(x=>x.date).sort((a,b)=> (a.date||"").localeCompare(b.date||""));
}

function renderAgenda(){
  const tbody = document.getElementById("agenda-tbody");
  if(!tbody) return;
  tbody.innerHTML = "";

  const year = (document.getElementById("agenda-year")?.value) || String(new Date().getFullYear());
  const range = (document.getElementById("agenda-range")?.value) || "90";
  const mode = (document.getElementById("agenda-mode")?.value) || "manual";

  const now = new Date();
  const maxDate = (range === "all") ? null : new Date(now.getTime() + Number(range)*86400000);

  const items = buildAgendaItems(mode).filter(it=>{
    const d = new Date(it.date);
    if(String(d.getFullYear()) !== String(year)) return false;
    if(maxDate && d > maxDate) return false;
    return true;
  });

  if(items.length === 0){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="4" class="small">Keine Einträge im gewählten Zeitraum.</td>`;
    tbody.appendChild(tr);
    return;
  }

  items.forEach(it=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${it.date}</td><td><b>${it.car}</b></td><td>${it.type}</td><td>${it.note||""}</td>`;
    tbody.appendChild(tr);
  });
}

/** =========================
 *  INVOICES (Upload + Open Fix)
 *  ========================= */
function addInvoice(event){
  event.preventDefault();
  if(!selectedVehicleId) return;

  const v = data.vehicles.find(x => x.id === selectedVehicleId);
  if(!v) return;

  const fileInput = document.getElementById("inv-file");
  const file = fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
  if(!file){
    alert("Bitte Datei auswählen (PDF/JPG/PNG).");
    return;
  }

  const invoice = {
    id: "inv_" + Date.now() + "_" + Math.floor(Math.random()*10000),
    date: document.getElementById("inv-date").value,
    amount: Number(document.getElementById("inv-amount").value || 0),
    vendor: document.getElementById("inv-vendor").value.trim(),
    type: document.getElementById("inv-type").value,
    file: null
  };

  const reader = new FileReader();
  reader.onload = () => {
    invoice.file = { name: file.name, type: file.type, data: reader.result };
    v.invoices = v.invoices || [];
    v.invoices.push(invoice);

    saveData();
    ensureYearDropdowns();
    renderCosts();
    renderInvoices();
    document.getElementById("invoice-form").reset();
  };
  reader.readAsDataURL(file);
}

function deleteInvoice(id){
  const v = data.vehicles.find(x => x.id === selectedVehicleId);
  if(!v) return;
  v.invoices = (v.invoices || []).filter(i => i.id !== id);
  saveData();
  ensureYearDropdowns();
  renderCosts();
  renderInvoices();
}

function openInvoiceFile(invoiceId){
  const v = data.vehicles.find(x => x.id === selectedVehicleId);
  if(!v) return;

  const inv = (v.invoices || []).find(i => i.id === invoiceId);
  if(!inv) return;

  // Backward compatibility: alt evtl. inv.file = dataURL string
  const dataUrl = (typeof inv.file === "string") ? inv.file : (inv.file && inv.file.data ? inv.file.data : null);
  if(!dataUrl) return;

  const parts = dataUrl.split(',');
  const meta = parts[0] || "";
  const b64  = parts[1] || "";

  const mimeMatch = meta.match(/data:(.*?);base64/);
  const mime = mimeMatch ? mimeMatch[1] : "application/octet-stream";

  const byteChars = atob(b64);
  const byteNumbers = new Array(byteChars.length);
  for (let i = 0; i < byteChars.length; i++) byteNumbers[i] = byteChars.charCodeAt(i);
  const blob = new Blob([new Uint8Array(byteNumbers)], { type: mime });

  const url = URL.createObjectURL(blob);
  window.open(url, "_blank");
  setTimeout(() => URL.revokeObjectURL(url), 60_000);
}

function renderInvoices(){
  const tbody = document.getElementById("invoice-tbody");
  tbody.innerHTML = "";
  if(!selectedVehicleId) return;

  const v = data.vehicles.find(x => x.id === selectedVehicleId);
  if(!v) return;

  const list = (v.invoices || []).slice().sort((a,b)=> (a.date||"").localeCompare(b.date||""));
  list.forEach(inv => {
    const openBtn = (inv.file && (inv.file.data || typeof inv.file === "string"))
      ? `<button class="btn-secondary btn-small" onclick="openInvoiceFile('${inv.id}')">Öffnen</button>`
      : "";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${inv.date || ""}</td>
      <td>${inv.type || ""}</td>
      <td>${money(inv.amount)}</td>
      <td>${inv.vendor || ""}</td>
      <td>${openBtn}</td>
      <td><button class="btn-danger btn-small" onclick="deleteInvoice('${inv.id}')">X</button></td>
    `;
    tbody.appendChild(tr);
  });
}

/** =========================
 *  BACKUP/RESTORE (CSV wrapper)
 *  ========================= */
function exportBackup(){
  const json = JSON.stringify(data);
  const b64 = btoa(unescape(encodeURIComponent(json)));
  const csv = "DATA\n" + b64 + "\n";

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "fuhrpark_backup_" + new Date().toISOString().slice(0,10) + ".csv";
  a.click();
}

function importBackup(event){
  const file = event.target.files && event.target.files[0] ? event.target.files[0] : null;
  if(!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    const text = String(reader.result || "");
    const lines = text.split(/\r?\n/).filter(Boolean);
    if(lines.length < 2 || lines[0].trim() !== "DATA"){
      alert("Backup-Datei ungültig.");
      return;
    }

    let imported;
    try{
      const json = decodeURIComponent(escape(atob(lines[1].trim())));
      imported = JSON.parse(json);
    }catch(e){
      alert("Backup konnte nicht gelesen werden.");
      return;
    }

    const replace = confirm("OK = ALLES ERSETZEN\nAbbrechen = ANHÄNGEN");
    if(replace){
      data = { vehicles: (imported.vehicles || []).map(migrateVehicle) };
    } else {
      const addList = (imported.vehicles || []).map(migrateVehicle);
      data.vehicles = mergeVehicleLists(data.vehicles.map(migrateVehicle), addList);
    }

    saveData();
    ensureYearDropdowns();
    renderVehicles();
    alert("Backup importiert ✅");
  };
  reader.readAsText(file);
}

/** =========================
 *  CSV IMPORT (robust)
 *  ========================= */
function detectDelimiter(firstLine){
  const commas = (firstLine.match(/,/g) || []).length;
  const semis  = (firstLine.match(/;/g) || []).length;
  return semis > commas ? ";" : ",";
}

function importCSV(event){
  const file = event.target.files && event.target.files[0] ? event.target.files[0] : null;
  if(!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    const text = String(reader.result || "");
    const lines = text.split(/\r?\n/).filter(l => l.trim().length);
    if(lines.length < 2){
      alert("CSV leer/ungültig.");
      return;
    }

    const delim = detectDelimiter(lines[0]);
    const header = lines[0].split(delim).map(h => h.trim().toLowerCase());

    const idx = (nameParts) => {
      for(let i=0;i<header.length;i++){
        const h = header[i];
        if(nameParts.some(p => h.includes(p))) return i;
      }
      return -1;
    };

    const iKenn = idx(["kenn", "kz", "kennzeichen", "nummernschild"]);
    const iMon  = idx(["monteur", "fahrer"]);
    const iMark = idx(["marke", "modell", "fahrzeug"]);
    const iGew  = idx(["gewicht"]);
    const iPick = idx(["pickerl", "tüv", "57a", "§57"]);
    const iLeas = idx(["leasing"]);
    const iLeasInfo = idx(["leasing info", "leasinginfo", "bank", "vertrag"]);
    const iNote = idx(["notiz", "vermerk", "bemerk", "besonder"]);
    const iServ = idx(["service", "wartung"]);

    let added = 0;

    for(let r=1; r<lines.length; r++){
      const cols = lines[r].split(delim);
      if(cols.length < 2) continue;

      const kenn = iKenn >= 0 ? (cols[iKenn] || "").trim() : (cols[0] || "").trim();
      if(!kenn) continue;

      const v = {
        id: "veh_" + Date.now() + "_" + Math.floor(Math.random()*10000) + "_" + r,
        kennzeichen: kenn,
        monteur: iMon >= 0 ? (cols[iMon] || "").trim() : "",
        marke: iMark >= 0 ? (cols[iMark] || "").trim() : "",
        gewicht: iGew >= 0 && (cols[iGew] || "").trim() ? Number(String(cols[iGew]).replace(",", ".").replace("t","").trim()) : null,
        pickerlBis: iPick >= 0 ? normalizeMonth((cols[iPick] || "").trim()) : "",
        leasingBis: iLeas >= 0 ? normalizeMonth((cols[iLeas] || "").trim()) : "",
        leasingInfo: iLeasInfo >= 0 ? (cols[iLeasInfo] || "").trim() : "",
        serviceDatum: iServ >= 0 ? (cols[iServ] || "").trim() : "",
        notizen: iNote >= 0 ? (cols[iNote] || "").trim() : "",
        reifenSommerStatus: "",
        reifenWinterStatus: "",
        reifenAllwetterStatus: "",
        reifenHaendler: "",
        reifenKaufdatum: "",
        appointments: [],
        invoices: []
      };

      data.vehicles.push(v);
      added++;
    }

    saveData();
    ensureYearDropdowns();
    renderVehicles();
    alert("CSV-Import fertig ✅ (" + added + " Fahrzeuge)");
  };

  reader.readAsText(file, "utf-8");
}

/** =========================
 *  START
 *  ========================= */
loadData();
fillMonthDropdown("pickerl-bis", 72);
fillMonthDropdown("leasing-bis", 72);
ensureYearDropdowns();
renderVehicles();
renderAgenda();
</script>
</body>
</html>
