<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fuhrpark Verwaltung – Elektro Jungbauer</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f3f4f6; }
    header { background:#111827; color:#f9fafb; padding:1rem 1.5rem; display:flex; justify-content:space-between; align-items:center; }
    header h1 { margin:0; font-size:1.15rem; }
    header small { opacity:.85; }
    main { padding:1rem; display:grid; grid-template-columns: 1.1fr 1.4fr; gap:1rem; }
    @media (max-width: 980px){ main { grid-template-columns:1fr; } }
    .card { background:#fff; border-radius:.6rem; padding:1rem; box-shadow: 0 1px 4px rgba(0,0,0,.08); }
    h2 { margin:.1rem 0 .7rem; font-size:1rem; }
    h3 { margin:1rem 0 .4rem; font-size:.95rem; }
    label { display:block; font-size:.8rem; margin-top:.5rem; margin-bottom:.1rem; }
    input[type="text"], input[type="date"], input[type="month"], input[type="number"], select, textarea {
      width:100%; box-sizing:border-box; padding:.35rem .45rem;
      border:1px solid #d1d5db; border-radius:.35rem; font-size:.85rem;
    }
    textarea { min-height:70px; }
    button { border:none; border-radius:.35rem; padding:.4rem .8rem; cursor:pointer; font-size:.85rem; }
    .btn-primary { background:#2563eb; color:#fff; }
    .btn-secondary { background:#e5e7eb; color:#111827; }
    .btn-danger { background:#dc2626; color:#fff; }
    .btn-small { font-size:.75rem; padding:.25rem .55rem; }
    table { width:100%; border-collapse:collapse; font-size:.8rem; }
    th, td { padding:.35rem .4rem; border-bottom:1px solid #e5e7eb; text-align:left; vertical-align:top; }
    th { background:#f9fafb; font-weight:600; }
    .flex { display:flex; gap:.6rem; flex-wrap:wrap; align-items:center; }
    .flex-between { display:flex; justify-content:space-between; align-items:center; gap:.5rem; flex-wrap:wrap; }
    .mt-1{ margin-top:.25rem; } .mt-2{ margin-top:.5rem; } .mt-3{ margin-top:.8rem; }
    .small { font-size:.78rem; color:#6b7280; }
    .badge { background:#e5e7eb; border-radius:999px; padding:.1rem .5rem; font-size:.7rem; display:inline-block; }
    .status-pill{ display:inline-block; padding:.12rem .5rem; border-radius:999px; font-size:.72rem; color:#fff; }
    .green{ background:#16a34a; } .orange{ background:#ea580c; } .red{ background:#dc2626; } .gray{ background:#6b7280; }
    hr { border:0; border-top:1px solid #e5e7eb; margin: .9rem 0; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body>
<header>
  <div>
    <h1>Fuhrpark Verwaltung</h1>
    <small>Elektro Jungbauer – lokal gespeichert</small>
  </div>
  <div class="small mono" id="storageInfo"></div>
</header>

<main>

  <!-- LINKS -->
  <section class="card">
    <div class="flex-between">
      <h2>Fahrzeuge</h2>
      <button class="btn-secondary btn-small" onclick="resetVehicleForm()">Neu</button>
    </div>

    <div class="mt-2">
      <label>Suche (Kennzeichen / Monteur / Marke)</label>
      <input type="text" id="search" placeholder="z.B. WN-..., Ali, VW..." oninput="renderVehicles()">
    </div>

    <table class="mt-2">
      <thead>
        <tr>
          <th>Kennzeichen</th>
          <th>Monteur</th>
          <th>Pickerl</th>
          <th>Leasing</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="vehicles-tbody"></tbody>
    </table>

    <hr>

    <h3>Import / Backup</h3>
    <div class="flex mt-2">
      <div style="flex:1; min-width:240px;">
        <label>CSV importieren (aus Excel)</label>
        <input type="file" id="csvInput" accept=".csv" onchange="importCSV(event)">
        <div class="small">Tipp: Excel als <b>CSV (UTF-8)</b> speichern.</div>
      </div>

      <div style="flex:1; min-width:240px;">
        <label>Backup (CSV-Datei)</label>
        <div class="flex">
          <button class="btn-secondary btn-small" onclick="exportBackup()">CSV-Backup erstellen</button>
          <input type="file" id="backupInput" accept=".csv" onchange="importBackup(event)">
        </div>
        <div class="small">Import fragt: <b>Ersetzen</b> oder <b>Anhängen</b>.</div>
      </div>
    </div>

    <hr>

    <h3>Fahrzeug anlegen / bearbeiten</h3>
    <form id="vehicle-form" onsubmit="saveVehicle(event)">
      <input type="hidden" id="vehicle-id">

      <label>Kennzeichen</label>
      <input type="text" id="kennzeichen" required>

      <label>Monteur</label>
      <input type="text" id="monteur">

      <label>Auto Marke / Modell</label>
      <input type="text" id="marke">

      <div class="flex">
        <div style="flex:1; min-width:180px;">
          <label>Gewicht (t)</label>
          <input type="number" step="0.01" id="gewicht">
        </div>
        <div style="flex:1; min-width:180px;">
          <label>Pickerl (Monat/Jahr)</label>
          <input type="month" id="pickerl-bis">
        </div>
      </div>

      <div class="flex mt-1">
        <div style="flex:1; min-width:180px;">
          <label>Leasing läuft bis (Monat/Jahr)</label>
          <input type="month" id="leasing-bis">
        </div>
        <div style="flex:1; min-width:180px;">
          <label>Leasing Info (Bank, Vertrag…)</label>
          <input type="text" id="leasing-info">
        </div>
      </div>

      <h3 class="mt-3">Reifenstatus</h3>
      <div class="flex">
        <div style="flex:1; min-width:180px;">
          <label>Sommerreifen</label>
          <select id="reifen-sommer-status">
            <option value="">–</option>
            <option value="ok">OK</option>
            <option value="bald">Bald</option>
            <option value="tausch">Fällig</option>
          </select>
        </div>
        <div style="flex:1; min-width:180px;">
          <label>Winterreifen</label>
          <select id="reifen-winter-status">
            <option value="">–</option>
            <option value="ok">OK</option>
            <option value="bald">Bald</option>
            <option value="tausch">Fällig</option>
          </select>
        </div>
        <div style="flex:1; min-width:180px;">
          <label>Allwetterreifen</label>
          <select id="reifen-allwetter-status">
            <option value="">–</option>
            <option value="ok">OK</option>
            <option value="bald">Bald</option>
            <option value="tausch">Fällig</option>
          </select>
        </div>
      </div>

      <div class="flex mt-1">
        <div style="flex:1; min-width:220px;">
          <label>Reifen gekauft bei</label>
          <input type="text" id="reifen-haendler" placeholder="z.B. BestDrive">
        </div>
        <div style="flex:1; min-width:220px;">
          <label>Reifen Kaufdatum (letzter Satz)</label>
          <input type="date" id="reifen-kaufdatum">
        </div>
      </div>

      <h3 class="mt-3">Service</h3>
      <div class="flex">
        <div style="flex:1; min-width:220px;">
          <label>Service gemacht am</label>
          <input type="date" id="service-datum">
        </div>
      </div>

      <label class="mt-2">Besondere Vermerke</label>
      <textarea id="notizen"></textarea>

      <div class="flex mt-2">
        <button type="submit" class="btn-primary">Speichern</button>
        <button type="button" class="btn-danger" onclick="deleteVehicle()" id="delete-vehicle-btn" style="display:none;">Fahrzeug löschen</button>
      </div>
    </form>

  </section>

  <!-- RECHTS -->
  <section class="card">
    <div class="flex-between">
      <h2 id="detail-title">Kein Fahrzeug ausgewählt</h2>
      <span id="detail-subtitle" class="small"></span>
    </div>

    <div id="detail-content" style="display:none;">
      <h3>Status</h3>
      <div class="flex">
        <div style="flex:1; min-width:220px;">
          <div class="small">Pickerl</div>
          <div id="pickerl-status-display"></div>
        </div>
        <div style="flex:1; min-width:220px;">
          <div class="small">Leasing</div>
          <div id="leasing-status-display"></div>
        </div>
      </div>

      <h3 class="mt-3">Reifen</h3>
      <div class="small" id="reifen-display"></div>

      <h3 class="mt-3">Service</h3>
      <div class="small" id="service-display"></div>

     
      </table>
<h3 class="mt-3">Kostenübersicht</h3>

<label>Jahr auswählen</label>
<select id="cost-year" onchange="renderCosts()"></select>

<div id="cost-summary" style="margin-top:8px;font-size:14px"></div>

      <h3 class="mt-3">Rechnungen</h3>
      <form id="invoice-form" onsubmit="addInvoice(event)">
        <div class="flex">
          <div style="flex:1; min-width:180px;">
            <label>Datum</label>
            <input type="date" id="inv-date" required>
          </div>
          <div style="flex:1; min-width:180px;">
            <label>Betrag (€)</label>
            <input type="number" step="0.01" id="inv-amount" required>
          </div>
        </div>

        <label class="mt-1">Werkstatt / Händler</label>
        <input type="text" id="inv-vendor">

        <label class="mt-1">Typ</label>
        <select id="inv-type">
          <option>Service</option>
          <option>Reifen</option>
          <option>Sonstiges</option>
        </select>

        <label class="mt-1">Datei (PDF / JPG / PNG)</label>
        <input type="file" id="inv-file" accept=".pdf,.jpg,.jpeg,.png">

        <div class="flex mt-2">
          <button class="btn-primary btn-small" type="submit">Rechnung speichern</button>
          <span class="small">Hinweis: viele große PDFs können den Browser-Speicher füllen.</span>
        </div>
      </form>

      <table class="mt-2">
        <thead>
          <tr>
            <th>Datum</th><th>Typ</th><th>€</th><th>Werkstatt</th><th>Datei</th><th></th>
          </tr>
        </thead>
        <tbody id="invoice-tbody"></tbody>
      </table>

      <h3 class="mt-3">Vermerke</h3>
      <div class="small" id="notizen-display"></div>
    </div>

    <div id="no-detail" class="small mt-2">
      Bitte links ein Fahrzeug öffnen.
    </div>
  </section>

</main>

<script>
/** =========================
 *  STABLE STORAGE + MIGRATION
 *  ========================= */
const STORAGE_KEY_STABLE = "fuhrpark_data_stable_v1";
const OLD_KEYS = ["fuhrpark_data_v1", "fuhrpark_data_v2", "fuhrpark_data_v2_backup"]; // safe list
let data = { vehicles: [] };
let selectedVehicleId = null;

function safeParseJSON(raw){
  try { return JSON.parse(raw); } catch { return null; }
}

function normalizeMonth(value){
  // Accept: YYYY-MM (preferred) or YYYY-MM-DD (old date), or empty
  if(!value) return "";
  if(typeof value !== "string") return "";
  if(/^\d{4}-\d{2}$/.test(value)) return value;
  if(/^\d{4}-\d{2}-\d{2}$/.test(value)) return value.slice(0,7);
  return value; // leave unknown as-is
}

function normalizeDate(value){
  if(!value) return "";
  if(typeof value !== "string") return "";
  if(/^\d{4}-\d{2}-\d{2}$/.test(value)) return value;
  // if YYYY-MM, convert to YYYY-MM-01 for display storage (optional)
  if(/^\d{4}-\d{2}$/.test(value)) return value + "-01";
  return value;
}

function migrateVehicle(v){
  // Map old v1 structure to stable structure
  // v1 fields: kennzeichen, monteur, marke, gewicht, pickerlBis, leasingBis, leasingInfo,
  //            reifenSommerStatus, reifenWinterStatus, reifenHaendler, reifenKaufdatum,
  //            notizen, fuelEntries, invoices (maybe), ...
  const id = v.id || ("veh_" + Date.now() + "_" + Math.floor(Math.random()*10000));
  const out = {
    id,
    kennzeichen: v.kennzeichen ?? v.kz ?? "",
    monteur: v.monteur ?? "",
    marke: v.marke ?? "",
    gewicht: (v.gewicht ?? null),
    pickerlBis: normalizeMonth(v.pickerlBis ?? v.pickerl ?? ""),
    leasingBis: normalizeMonth(v.leasingBis ?? v.leasing ?? ""),
    leasingInfo: v.leasingInfo ?? "",
    reifenSommerStatus: v.reifenSommerStatus ?? v.reifen?.sommer ?? "",
    reifenWinterStatus: v.reifenWinterStatus ?? v.reifen?.winter ?? "",
    reifenAllwetterStatus: v.reifenAllwetterStatus ?? v.reifen?.all ?? "",
    reifenHaendler: v.reifenHaendler ?? "",
    reifenKaufdatum: v.reifenKaufdatum ?? "",
    serviceDatum: v.serviceDatum ?? v.service_datum ?? "",
    notizen: v.notizen ?? v.notiz ?? "",
    fuelEntries: Array.isArray(v.fuelEntries) ? v.fuelEntries : [],
    invoices: Array.isArray(v.invoices) ? v.invoices : []
  };

  // Normalize fuel entries
  out.fuelEntries = out.fuelEntries.map(e => ({
    id: e.id || ("fuel_" + Date.now() + "_" + Math.floor(Math.random()*10000)),
    datum: e.datum || "",
    betrag: (e.betrag != null ? Number(e.betrag) : 0),
    liter: (e.liter != null && e.liter !== "" ? Number(e.liter) : null),
    km: (e.km != null && e.km !== "" ? Number(e.km) : null),
    rechnungsinfo: e.rechnungsinfo || ""
  }));

  // Normalize invoices (file stored as dataURL)
  out.invoices = out.invoices.map(inv => ({
    id: inv.id || ("inv_" + Date.now() + "_" + Math.floor(Math.random()*10000)),
    date: inv.date || "",
    amount: inv.amount != null ? Number(inv.amount) : 0,
    vendor: inv.vendor || "",
    type: inv.type || "Sonstiges",
    file: inv.file || null // {name, type?, data}
  }));

  return out;
}

function mergeVehicleLists(listA, listB){
  // Merge by kennzeichen if possible, else by id
  const map = new Map();
  const add = (v) => {
    const key = (v.kennzeichen || "").trim().toUpperCase() || v.id;
    if(!key) return;
    if(!map.has(key)) map.set(key, v);
    else {
      // merge: prefer non-empty fields from newer v
      const old = map.get(key);
      const merged = {...old};
      for(const k in v){
        if(v[k] != null && v[k] !== "" && !(Array.isArray(v[k]) && v[k].length === 0)){
          merged[k] = v[k];
        }
      }
      // merge arrays carefully
      merged.fuelEntries = (old.fuelEntries||[]).concat(v.fuelEntries||[]);
      merged.invoices = (old.invoices||[]).concat(v.invoices||[]);
      map.set(key, merged);
    }
  };
  (listA||[]).forEach(add);
  (listB||[]).forEach(add);
  return Array.from(map.values());
}

function loadData(){
  // 1) stable first
  const stableRaw = localStorage.getItem(STORAGE_KEY_STABLE);
  if(stableRaw){
    const stable = safeParseJSON(stableRaw);
    if(stable && Array.isArray(stable.vehicles)){
      data.vehicles = stable.vehicles.map(migrateVehicle);
      saveData();
      return;
    }
  }

  // 2) try old keys; pick the one with most vehicles, and merge if multiple exist
  let collected = [];
  for(const k of OLD_KEYS){
    const raw = localStorage.getItem(k);
    const j = raw ? safeParseJSON(raw) : null;
    if(j && Array.isArray(j.vehicles) && j.vehicles.length){
      collected.push({key:k, vehicles: j.vehicles});
    }
  }

  if(collected.length){
    // normalize each
    const normalizedLists = collected.map(x => x.vehicles.map(migrateVehicle));
    // merge all lists
    let merged = normalizedLists[0];
    for(let i=1;i<normalizedLists.length;i++){
      merged = mergeVehicleLists(merged, normalizedLists[i]);
    }
    data.vehicles = merged;
    saveData();
  } else {
    data = { vehicles: [] };
    saveData();
  }
}

function saveData(){
  localStorage.setItem(STORAGE_KEY_STABLE, JSON.stringify(data));
  document.getElementById("storageInfo").textContent = "Storage: " + STORAGE_KEY_STABLE;
}

/** =========================
 *  HELPERS
 *  ========================= */
function formatMonthYM(ym){
  if(!ym) return "";
  if(/^\d{4}-\d{2}$/.test(ym)){
    const [y,m] = ym.split("-");
    return m + "." + y;
  }
  if(/^\d{4}-\d{2}-\d{2}$/.test(ym)){
    const [y,m] = ym.split("-");
    return m + "." + y;
  }
  return ym;
}

function getMonthEndDate(ym){
  if(!ym) return null;
  let year, month;
  if(/^\d{4}-\d{2}$/.test(ym)){
    [year, month] = ym.split("-").map(Number);
  } else if(/^\d{4}-\d{2}-\d{2}$/.test(ym)){
    const parts = ym.split("-").map(Number);
    year = parts[0]; month = parts[1];
  } else {
    return null;
  }
  return new Date(year, month, 0); // last day of that month
}

function getPickerlStatus(ym){
  if(!ym) return { text:"kein Datum", cls:"gray" };
  const end = getMonthEndDate(ym);
  if(!end) return { text:"ungültig ("+ym+")", cls:"gray" };
  const now = new Date();
  const diffDays = Math.ceil((end - now) / 86400000);
  const formatted = formatMonthYM(ym);
  if(diffDays < 0) return { text:"abgelaufen ("+formatted+")", cls:"red" };
  if(diffDays <= 31) return { text:"bald fällig ("+formatted+")", cls:"orange" };
  return { text:"OK bis "+formatted, cls:"green" };
}

function getLeasingStatus(ym){
  if(!ym) return { text:"kein Datum", cls:"gray" };
  const end = getMonthEndDate(ym);
  if(!end) return { text:"ungültig ("+ym+")", cls:"gray" };
  const now = new Date();
  // months diff approx:
  const months = (end.getFullYear()-now.getFullYear())*12 + (end.getMonth()-now.getMonth());
  const formatted = formatMonthYM(ym);
  if(end < now) return { text:"abgelaufen ("+formatted+")", cls:"red" };
  if(months <= 6) return { text:"läuft bald aus ("+formatted+")", cls:"orange" };
  return { text:"läuft bis "+formatted, cls:"green" };
}

function statusPillForReifen(val){
  if(val === "ok") return `<span class="status-pill green">OK</span>`;
  if(val === "bald") return `<span class="status-pill orange">Bald</span>`;
  if(val === "tausch") return `<span class="status-pill red">Fällig</span>`;
  return `<span class="status-pill gray">–</span>`;
}

/** =========================
 *  RENDER
 *  ========================= */
function renderVehicles(){
  const q = (document.getElementById("search").value || "").trim().toLowerCase();
  const tbody = document.getElementById("vehicles-tbody");
  tbody.innerHTML = "";

  const list = (data.vehicles || []).slice().sort((a,b) => (a.kennzeichen||"").localeCompare(b.kennzeichen||""));

  list.forEach(v => {
    const hay = ((v.kennzeichen||"")+" "+(v.monteur||"")+" "+(v.marke||"")).toLowerCase();
    if(q && !hay.includes(q)) return;

    const p = getPickerlStatus(v.pickerlBis);
    const l = getLeasingStatus(v.leasingBis);

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${v.kennzeichen||""}</td>
      <td>${v.monteur||""}</td>
      <td><span class="badge">${p.text}</span></td>
      <td><span class="badge">${l.text}</span></td>
      <td><button class="btn-secondary btn-small" onclick="selectVehicle('${v.id}')">Öffnen</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function resetVehicleForm(){
  document.getElementById("vehicle-id").value = "";
  document.getElementById("kennzeichen").value = "";
  document.getElementById("monteur").value = "";
  document.getElementById("marke").value = "";
  document.getElementById("gewicht").value = "";
  document.getElementById("pickerl-bis").value = "";
  document.getElementById("leasing-bis").value = "";
  document.getElementById("leasing-info").value = "";
  document.getElementById("reifen-sommer-status").value = "";
  document.getElementById("reifen-winter-status").value = "";
  document.getElementById("reifen-allwetter-status").value = "";
  document.getElementById("reifen-haendler").value = "";
  document.getElementById("reifen-kaufdatum").value = "";
  document.getElementById("service-datum").value = "";
  document.getElementById("notizen").value = "";
  document.getElementById("delete-vehicle-btn").style.display = "none";
}

function selectVehicle(id){
  selectedVehicleId = id;
  const v = data.vehicles.find(x => x.id === id);
  if(!v) return;

  // Fill form
  document.getElementById("vehicle-id").value = v.id;
  document.getElementById("kennzeichen").value = v.kennzeichen || "";
  document.getElementById("monteur").value = v.monteur || "";
  document.getElementById("marke").value = v.marke || "";
  document.getElementById("gewicht").value = (v.gewicht != null ? v.gewicht : "");
  document.getElementById("pickerl-bis").value = v.pickerlBis || "";
  document.getElementById("leasing-bis").value = v.leasingBis || "";
  document.getElementById("leasing-info").value = v.leasingInfo || "";
  document.getElementById("reifen-sommer-status").value = v.reifenSommerStatus || "";
  document.getElementById("reifen-winter-status").value = v.reifenWinterStatus || "";
  document.getElementById("reifen-allwetter-status").value = v.reifenAllwetterStatus || "";
  document.getElementById("reifen-haendler").value = v.reifenHaendler || "";
  document.getElementById("reifen-kaufdatum").value = v.reifenKaufdatum || "";
  document.getElementById("service-datum").value = v.serviceDatum || "";
  document.getElementById("notizen").value = v.notizen || "";

  document.getElementById("delete-vehicle-btn").style.display = "inline-block";

  // Detail view
  document.getElementById("detail-title").textContent = v.kennzeichen || "(ohne Kennzeichen)";
  document.getElementById("detail-subtitle").textContent = (v.monteur || "") + (v.marke ? " – " + v.marke : "");

  const detailContent = document.getElementById("detail-content");
  const noDetail = document.getElementById("no-detail");
  detailContent.style.display = "block";
  noDetail.style.display = "none";

  const p = getPickerlStatus(v.pickerlBis);
  const l = getLeasingStatus(v.leasingBis);

  document.getElementById("pickerl-status-display").innerHTML = `<span class="status-pill ${p.cls}">${p.text}</span>`;
  document.getElementById("leasing-status-display").innerHTML = `<span class="status-pill ${l.cls}">${l.text}${v.leasingInfo ? " | " + v.leasingInfo : ""}</span>`;

  document.getElementById("reifen-display").innerHTML = `
    Sommer: ${statusPillForReifen(v.reifenSommerStatus)} &nbsp;|&nbsp;
    Winter: ${statusPillForReifen(v.reifenWinterStatus)} &nbsp;|&nbsp;
    Allwetter: ${statusPillForReifen(v.reifenAllwetterStatus)}
    <div class="mt-1">
      Händler: <b>${(v.reifenHaendler||"-")}</b>
      ${v.reifenKaufdatum ? " | Kaufdatum: <b>"+v.reifenKaufdatum+"</b>" : ""}
    </div>
  `;

  document.getElementById("service-display").innerHTML =
    v.serviceDatum ? `Service gemacht am: <b>${v.serviceDatum}</b>` : `<span class="badge">kein Service-Datum</span>`;

  document.getElementById("notizen-display").textContent = v.notizen || "–";

  renderFuelTable();
  renderInvoices();
}

function saveVehicle(event){
  event.preventDefault();
  const id = document.getElementById("vehicle-id").value || ("veh_" + Date.now() + "_" + Math.floor(Math.random()*10000));
  const existing = data.vehicles.find(x => x.id === id);

  const payload = {
    id,
    kennzeichen: document.getElementById("kennzeichen").value.trim(),
    monteur: document.getElementById("monteur").value.trim(),
    marke: document.getElementById("marke").value.trim(),
    gewicht: document.getElementById("gewicht").value ? Number(document.getElementById("gewicht").value) : null,
    pickerlBis: normalizeMonth(document.getElementById("pickerl-bis").value || ""),
    leasingBis: normalizeMonth(document.getElementById("leasing-bis").value || ""),
    leasingInfo: document.getElementById("leasing-info").value.trim(),
    reifenSommerStatus: document.getElementById("reifen-sommer-status").value,
    reifenWinterStatus: document.getElementById("reifen-winter-status").value,
    reifenAllwetterStatus: document.getElementById("reifen-allwetter-status").value,
    reifenHaendler: document.getElementById("reifen-haendler").value.trim(),
    reifenKaufdatum: document.getElementById("reifen-kaufdatum").value || "",
    serviceDatum: document.getElementById("service-datum").value || "",
    notizen: document.getElementById("notizen").value.trim()
  };

  if(existing){
    // keep arrays
    payload.fuelEntries = existing.fuelEntries || [];
    payload.invoices = existing.invoices || [];
    Object.assign(existing, payload);
  } else {
    payload.fuelEntries = [];
    payload.invoices = [];
    data.vehicles.push(payload);
  }

  saveData();
  renderVehicles();
  document.getElementById("vehicle-id").value = id;
  document.getElementById("delete-vehicle-btn").style.display = "inline-block";
  selectVehicle(id);
}

function deleteVehicle(){
  const id = document.getElementById("vehicle-id").value;
  if(!id) return;
  if(!confirm("Fahrzeug wirklich löschen?")) return;

  data.vehicles = data.vehicles.filter(v => v.id !== id);
  saveData();
  renderVehicles();
  resetVehicleForm();
  selectedVehicleId = null;

  document.getElementById("detail-content").style.display = "none";
  document.getElementById("no-detail").style.display = "block";
  document.getElementById("detail-title").textContent = "Kein Fahrzeug ausgewählt";
  document.getElementById("detail-subtitle").textContent = "";
}

/** =========================
 *  TANKEN (ohne Diagramm)
 *  ========================= */
function addFuelEntry(event){
  event.preventDefault();
  if(!selectedVehicleId) return;

  const v = data.vehicles.find(x => x.id === selectedVehicleId);
  if(!v) return;

  const entry = {
    id: "fuel_" + Date.now() + "_" + Math.floor(Math.random()*10000),
    datum: document.getElementById("fuel-datum").value,
    betrag: Number(document.getElementById("fuel-betrag").value || 0),
    liter: document.getElementById("fuel-liter").value ? Number(document.getElementById("fuel-liter").value) : null,
    km: document.getElementById("fuel-km").value ? Number(document.getElementById("fuel-km").value) : null,
    rechnungsinfo: document.getElementById("fuel-rechnungsinfo").value.trim()
  };

  v.fuelEntries = v.fuelEntries || [];
  v.fuelEntries.push(entry);

  saveData();
  document.getElementById("fuel-form").reset();
  renderFuelTable();
}

function deleteFuelEntry(id){
  const v = data.vehicles.find(x => x.id === selectedVehicleId);
  if(!v) return;
  v.fuelEntries = (v.fuelEntries || []).filter(e => e.id !== id);
  saveData();
  renderFuelTable();
}

function renderFuelTable(){
  const tbody = document.getElementById("fuel-tbody");
  tbody.innerHTML = "";
  if(!selectedVehicleId) return;

  const v = data.vehicles.find(x => x.id === selectedVehicleId);
  if(!v) return;

  const entries = (v.fuelEntries || []).slice().sort((a,b)=> new Date(a.datum) - new Date(b.datum));
  entries.forEach(e => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${e.datum || ""}</td>
      <td>${(e.betrag != null ? Number(e.betrag).toFixed(2) : "")}</td>
      <td>${(e.liter != null ? Number(e.liter).toFixed(2) : "")}</td>
      <td>${(e.km != null ? e.km : "")}</td>
      <td>${e.rechnungsinfo || ""}</td>
      <td><button class="btn-danger btn-small" onclick="deleteFuelEntry('${e.id}')">X</button></td>
    `;
    tbody.appendChild(tr);
  });
}

/** =========================
 *  RECHNUNGEN (Upload lokal)
 *  ========================= */
function addInvoice(event){
  event.preventDefault();
  if(!selectedVehicleId) return;

  const v = data.vehicles.find(x => x.id === selectedVehicleId);
  if(!v) return;

  const fileInput = document.getElementById("inv-file");
  const file = fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;

  const invoiceBase = {
    id: "inv_" + Date.now() + "_" + Math.floor(Math.random()*10000),
    date: document.getElementById("inv-date").value,
    amount: Number(document.getElementById("inv-amount").value || 0),
    vendor: document.getElementById("inv-vendor").value.trim(),
    type: document.getElementById("inv-type").value,
    file: null
  };

  if(!file){
    alert("Bitte Datei auswählen (PDF/JPG/PNG).");
    return;
  }

  const reader = new FileReader();
  reader.onload = () => {
    invoiceBase.file = { name: file.name, type: file.type, data: reader.result };
    v.invoices = v.invoices || [];
    v.invoices.push(invoiceBase);

    saveData();
    renderInvoices();
    document.getElementById("invoice-form").reset();
  };
  reader.readAsDataURL(file);
}

function deleteInvoice(id){
  const v = data.vehicles.find(x => x.id === selectedVehicleId);
  if(!v) return;
  v.invoices = (v.invoices || []).filter(i => i.id !== id);
  saveData();
  renderInvoices();
}

function renderInvoices(){
  const tbody = document.getElementById("invoice-tbody");
  tbody.innerHTML = "";
  if(!selectedVehicleId) return;

  const v = data.vehicles.find(x => x.id === selectedVehicleId);
  if(!v) return;

  const list = (v.invoices || []).slice().sort((a,b)=> (a.date||"").localeCompare(b.date||""));
  list.forEach(inv => {
    const fileLink = inv.file && inv.file.data
      ? `<a href="${inv.file.data}" target="_blank">${inv.file.name || "Datei"}</a>`
      : "";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${inv.date || ""}</td>
      <td>${inv.type || ""}</td>
      <td>${(inv.amount != null ? Number(inv.amount).toFixed(2) : "")}</td>
      <td>${inv.vendor || ""}</td>
      <td>${fileLink}</td>
      <td><button class="btn-danger btn-small" onclick="deleteInvoice('${inv.id}')">X</button></td>
    `;
    tbody.appendChild(tr);
  });
}

/** =========================
 *  BACKUP/RESTORE (CSV wrapper)
 *  ========================= */
function exportBackup(){
  // CSV wrapper: 1st line header, 2nd line base64(json)
  const json = JSON.stringify(data);
  const b64 = btoa(unescape(encodeURIComponent(json)));
  const csv = "DATA\n" + b64 + "\n";

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "fuhrpark_backup_" + new Date().toISOString().slice(0,10) + ".csv";
  a.click();
}

function importBackup(event){
  const file = event.target.files && event.target.files[0] ? event.target.files[0] : null;
  if(!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    const text = String(reader.result || "");
    const lines = text.split(/\r?\n/).filter(Boolean);
    if(lines.length < 2 || lines[0].trim() !== "DATA"){
      alert("Backup-Datei ungültig.");
      return;
    }

    let imported;
    try{
      const json = decodeURIComponent(escape(atob(lines[1].trim())));
      imported = JSON.parse(json);
    }catch(e){
      alert("Backup konnte nicht gelesen werden.");
      return;
    }

    const replace = confirm("OK = ALLES ERSETZEN\nAbbrechen = ANHÄNGEN");
    if(replace){
      data = { vehicles: (imported.vehicles || []).map(migrateVehicle) };
    } else {
      const addList = (imported.vehicles || []).map(migrateVehicle);
      data.vehicles = mergeVehicleLists(data.vehicles.map(migrateVehicle), addList);
    }

    saveData();
    renderVehicles();
    alert("Backup importiert ✅");
  };
  reader.readAsText(file);
}

/** =========================
 *  CSV IMPORT (robust)
 *  ========================= */
function detectDelimiter(firstLine){
  const commas = (firstLine.match(/,/g) || []).length;
  const semis  = (firstLine.match(/;/g) || []).length;
  return semis > commas ? ";" : ",";
}

function importCSV(event){
  const file = event.target.files && event.target.files[0] ? event.target.files[0] : null;
  if(!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    const text = String(reader.result || "");
    const lines = text.split(/\r?\n/).filter(l => l.trim().length);
    if(lines.length < 2){
      alert("CSV leer/ungültig.");
      return;
    }

    const delim = detectDelimiter(lines[0]);
    const header = lines[0].split(delim).map(h => h.trim().toLowerCase());

    const idx = (nameParts) => {
      for(let i=0;i<header.length;i++){
        const h = header[i];
        if(nameParts.some(p => h.includes(p))) return i;
      }
      return -1;
    };

    // Try to map by header names (best)
    const iKenn = idx(["kenn", "kz", "kennzeichen", "nummernschild"]);
    const iMon  = idx(["monteur", "fahrer"]);
    const iMark = idx(["marke", "modell", "fahrzeug"]);
    const iGew  = idx(["gewicht", "t "]);
    const iPick = idx(["pickerl", "pickel", "tüv", "§57"]);
    const iLeas = idx(["leasing"]);
    const iLeasInfo = idx(["leasing info", "leasinginfo", "bank", "vertrag"]);
    const iNote = idx(["notiz", "vermerk", "bemerk", "besonder"]);
    const iServ = idx(["service", "wartung"]);

    let added = 0;

    for(let r=1; r<lines.length; r++){
      const cols = lines[r].split(delim);
      if(cols.length < 2) continue;

      const kenn = iKenn >= 0 ? (cols[iKenn] || "").trim() : (cols[0] || "").trim();
      if(!kenn) continue;

      const v = {
        id: "veh_" + Date.now() + "_" + Math.floor(Math.random()*10000) + "_" + r,
        kennzeichen: kenn,
        monteur: iMon >= 0 ? (cols[iMon] || "").trim() : "",
        marke: iMark >= 0 ? (cols[iMark] || "").trim() : "",
        gewicht: iGew >= 0 && (cols[iGew] || "").trim() ? Number(String(cols[iGew]).replace(",", ".").replace("t","").trim()) : null,
        pickerlBis: iPick >= 0 ? normalizeMonth((cols[iPick] || "").trim()) : "",
        leasingBis: iLeas >= 0 ? normalizeMonth((cols[iLeas] || "").trim()) : "",
        leasingInfo: iLeasInfo >= 0 ? (cols[iLeasInfo] || "").trim() : "",
        serviceDatum: iServ >= 0 ? normalizeDate((cols[iServ] || "").trim()).slice(0,10) : "",
        notizen: iNote >= 0 ? (cols[iNote] || "").trim() : "",
        reifenSommerStatus: "",
        reifenWinterStatus: "",
        reifenAllwetterStatus: "",
        reifenHaendler: "",
        reifenKaufdatum: "",
        fuelEntries: [],
        invoices: []
      };

      data.vehicles.push(v);
      added++;
    }

    saveData();
    renderVehicles();
    alert("CSV-Import fertig ✅ (" + added + " Fahrzeuge)");
  };

  reader.readAsText(file, "utf-8");
}

/** =========================
 *  START
 *  ========================= */
loadData();
renderVehicles();
</script>
</body>
</html>
