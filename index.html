<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Fuhrpark Verwaltung – Elektro Jungbauer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{font-family:Arial,sans-serif;margin:0;background:#f3f4f6}
header{background:#111827;color:#f9fafb;padding:1rem 1.5rem;display:flex;justify-content:space-between;align-items:center}
main{padding:1rem;display:grid;grid-template-columns:1.1fr 1.4fr;gap:1rem}
@media(max-width:900px){main{grid-template-columns:1fr}}
.card{background:#fff;border-radius:.5rem;padding:1rem;box-shadow:0 1px 4px rgba(0,0,0,.08)}
h2,h3{margin:.2rem 0 .5rem 0}
label{font-size:.8rem}
input,select,textarea{width:100%;padding:.3rem;margin:.1rem 0;border:1px solid #d1d5db;border-radius:.3rem;font-size:.85rem}
button{border:none;border-radius:.3rem;padding:.35rem .7rem;font-size:.8rem;cursor:pointer}
.btn-primary{background:#2563eb;color:#fff}
.btn-secondary{background:#e5e7eb}
.btn-danger{background:#dc2626;color:#fff}
table{width:100%;border-collapse:collapse;font-size:.8rem}
th,td{padding:.3rem;border-bottom:1px solid #e5e7eb;text-align:left}
.status-pill{padding:.1rem .4rem;border-radius:999px;font-size:.7rem;color:#fff}
.status-green{background:#16a34a}
.status-orange{background:#ea580c}
.status-red{background:#dc2626}
.status-gray{background:#6b7280}
.flex{display:flex;gap:.5rem;flex-wrap:wrap}
.flex-between{display:flex;justify-content:space-between;align-items:center}
.mt-2{margin-top:.5rem}.mt-3{margin-top:.8rem}
</style>
</head>
<body>

<header>
  <h1>Fuhrpark Verwaltung</h1>
  <small>Elektro Jungbauer – lokal gespeichert</small>
</header>

<h3 style="padding:1rem 1rem 0 1rem">Fahrzeuge importieren (CSV)</h3>
<input style="margin-left:1rem" type="file" accept=".csv" onchange="importCSV(event)">
<button onclick="exportBackup()" class="btn-secondary" style="margin-left:1rem">CSV‑Backup</button>
<input style="margin-left:1rem" type="file" accept=".csv" onchange="importBackup(event)">

<main>

<section class="card">
<h2>Fahrzeuge</h2>
<table>
<thead><tr><th>Kennzeichen</th><th>Monteur</th><th>Pickerl</th><th></th></tr></thead>
<tbody id="vehicles-tbody"></tbody>
</table>

<h3 class="mt-3">Fahrzeug anlegen</h3>
<form onsubmit="saveVehicle(event)">
<input type="hidden" id="vid">
<label>Kennzeichen</label><input id="kennzeichen" required>
<label>Monteur</label><input id="monteur">
<label>Pickerl (Monat/Jahr)</label><input type="month" id="pickerl">
<button class="btn-primary mt-2">Speichern</button>
</form>
</section>

<section class="card">
<h2 id="detail-title">Kein Fahrzeug gewählt</h2>
<div id="detail" style="display:none">

<h3 class="mt-3">Rechnungen</h3>
<form onsubmit="addInvoice(event)">
<div class="flex">
<input type="date" id="inv-date" required>
<input type="number" id="inv-amount" step="0.01" placeholder="€" required>
</div>
<input id="inv-vendor" placeholder="Werkstatt">
<select id="inv-type"><option>Service</option><option>Reifen</option><option>Sonstiges</option></select>
<input type="file" id="inv-file" accept=".pdf,.jpg,.png">
<button class="btn-primary mt-2">Rechnung speichern</button>
</form>

<table class="mt-2">
<thead><tr><th>Datum</th><th>Typ</th><th>Betrag</th><th>Datei</th><th></th></tr></thead>
<tbody id="invoice-tbody"></tbody>
</table>

</div>
</section>

</main>

<script>
const KEY="fuhrpark_data_v2";
let data={vehicles:[]},selected=null;

function save(){localStorage.setItem(KEY,JSON.stringify(data))}
function load(){const r=localStorage.getItem(KEY);if(r)data=JSON.parse(r)}

function pickerStatus(val){
 if(!val)return{t:"kein Datum",c:"status-gray"};
 const[y,m]=val.split("-").map(Number);
 const end=new Date(y,m,0),now=new Date();
 const diff=(end-now)/86400000;
 const txt=m+"."+y;
 if(diff<0)return{t:"abgelaufen "+txt,c:"status-red"};
 if(diff<=31)return{t:"bald "+txt,c:"status-orange"};
 return{t:"OK bis "+txt,c:"status-green"};
}

function renderVehicles(){
 const tb=document.getElementById("vehicles-tbody");tb.innerHTML="";
 data.vehicles.forEach(v=>{
  const s=pickerStatus(v.pickerl);
  tb.innerHTML+=`<tr><td>${v.kz}</td><td>${v.monteur||""}</td>
  <td><span class="status-pill ${s.c}">${s.t}</span></td>
  <td><button onclick="selectVehicle('${v.id}')">Öffnen</button></td></tr>`;
 });
}

function saveVehicle(e){
 e.preventDefault();
 const id=document.getElementById("vid").value||"v"+Date.now();
 let v=data.vehicles.find(x=>x.id===id);
 if(!v){v={id, invoices:[]};data.vehicles.push(v)}
 v.kz=kennzeichen.value;v.monteur=monteur.value;v.pickerl=pickerl.value;
 save();renderVehicles();selectVehicle(id);e.target.reset();
}

function selectVehicle(id){
 selected=id;
 const v=data.vehicles.find(x=>x.id===id);
 document.getElementById("detail").style.display="block";
 document.getElementById("detail-title").textContent=v.kz;
 renderInvoices();
}

function addInvoice(e){
 e.preventDefault();
 const v=data.vehicles.find(x=>x.id===selected);
 const f=document.getElementById("inv-file").files[0];
 if(!f)return;
 const r=new FileReader();
 r.onload=()=>{
  v.invoices.push({id:Date.now(),d:document.getElementById("inv-date").value,a:document.getElementById("inv-amount").value,t:document.getElementById("inv-type").value,f:r.result,n:f.name});
  save();renderInvoices();e.target.reset();
 };
 r.readAsDataURL(f);
}

function renderInvoices(){
 const v=data.vehicles.find(x=>x.id===selected);
 const tb=document.getElementById("invoice-tbody");tb.innerHTML="";
 v.invoices.forEach(i=>{
  tb.innerHTML+=`<tr><td>${i.d}</td><td>${i.t}</td><td>${i.a}</td><td><a href="${i.f}" target="_blank">${i.n}</a></td>
  <td><button onclick="delInv(${i.id})">X</button></td></tr>`;
 });
}

function delInv(id){
 const v=data.vehicles.find(x=>x.id===selected);
 v.invoices=v.invoices.filter(i=>i.id!==id);save();renderInvoices();
}

function exportBackup(){
 const blob=new Blob([JSON.stringify(data)],{type:"application/json"});
 const a=document.createElement("a");
 a.href=URL.createObjectURL(blob);
 a.download="fuhrpark_backup.json";a.click();
}

function importBackup(e){
 const f=e.target.files[0];if(!f)return;
 const r=new FileReader();
 r.onload=()=>{const j=JSON.parse(r.result);
  if(confirm("OK = ERSETZEN, Abbrechen = ANHÄNGEN"))data=j;
  else data.vehicles=data.vehicles.concat(j.vehicles||[]);
  save();renderVehicles();
 };
 r.readAsText(f);
}

function importCSV(e){
 const f=e.target.files[0];if(!f)return;
 const r=new FileReader();
 r.onload=()=>{
  const l=r.result.split("\n").slice(1);
  l.forEach(x=>{
   const c=x.split(";");
   if(c[1])data.vehicles.push({id:"v"+Date.now()+Math.random(),kz:c[1],monteur:c[2],pickerl:c[4],invoices:[]});
  });
  save();renderVehicles();
 };
 r.readAsText(f,"utf-8");
}

load();renderVehicles();
</script>
</body>
</html>
